families_dict = {
    "i080": {
        "i080-001": "Ps",
        "i080-002": "Ps",
        "i080-003": "Ps",
        "i080-004": "Ps",
        "i080-005": "Ps",
        "i080-011": "Ps",
        "i080-012": "Ps",
        "i080-013": "Ps",
        "i080-014": "Ps",
        "i080-015": "Ps",
        "i080-021": "Ps",
        "i080-022": "Ps",
        "i080-023": "Ps",
        "i080-024": "Ps",
        "i080-025": "Ps",
        "i080-031": "Ps",
        "i080-032": "Ps",
        "i080-033": "Ps",
        "i080-034": "Ps",
        "i080-035": "Ps",
        "i080-041": "Ps",
        "i080-042": "Ps",
        "i080-043": "Ps",
        "i080-044": "NPs",
        "i080-045": "Ps",
        "i080-101": "Ps",
        "i080-102": "Ps",
        "i080-103": "Ps",
        "i080-104": "Ps",
        "i080-105": "Ps",
        "i080-111": "NPs",
        "i080-112": "Ps",
        "i080-113": "Ps",
        "i080-114": "Ps",
        "i080-115": "Ps",
        "i080-121": "Ps",
        "i080-122": "Ps",
        "i080-123": "Ps",
        "i080-124": "Ls",
        "i080-125": "Ps",
        "i080-131": "Ps",
        "i080-132": "Ps",
        "i080-133": "Ps",
        "i080-134": "Ps",
        "i080-135": "Ps",
        "i080-141": "Ps",
        "i080-142": "Ps",
        "i080-143": "NPs",
        "i080-144": "Ps",
        "i080-145": "Ps",
        "i080-201": "Ps",
        "i080-202": "Ps",
        "i080-203": "Ps",
        "i080-204": "Ps",
        "i080-205": "Ps",
        "i080-211": "Ps",
        "i080-212": "NPs",
        "i080-213": "NPs",
        "i080-214": "NPs",
        "i080-215": "NPs",
        "i080-221": "Ps",
        "i080-222": "Ps",
        "i080-223": "Ps",
        "i080-224": "Ps",
        "i080-225": "Ps",
        "i080-231": "Ps",
        "i080-232": "Ps",
        "i080-233": "Ps",
        "i080-234": "Ps",
        "i080-235": "NPs",
        "i080-241": "NPm",
        "i080-242": "Pm",
        "i080-243": "NPm",
        "i080-244": "NPs",
        "i080-245": "NPs",
        "i080-301": "Ps",
        "i080-302": "Ps",
        "i080-303": "Ps",
        "i080-304": "Ps",
        "i080-305": "NPs",
        "i080-311": "Ps",
        "i080-312": "NPs",
        "i080-313": "Ps",
        "i080-314": "NPs",
        "i080-315": "NPs",
        "i080-321": "Ps",
        "i080-322": "Ps",
        "i080-323": "Ps",
        "i080-324": "Ps",
        "i080-325": "Ps",
        "i080-331": "NPs",
        "i080-332": "NPs",
        "i080-333": "Ps",
        "i080-334": "Ps",
        "i080-335": "Ps",
        "i080-341": "Ps",
        "i080-342": "NPm",
        "i080-343": "NPs",
        "i080-344": "NPs",
        "i080-345": "NPm",
    },
    "i160": {
        "i160-001": "Ps",
        "i160-002": "Ps",
        "i160-003": "Ps",
        "i160-004": "Ps",
        "i160-005": "Ps",
        "i160-011": "Ps",
        "i160-012": "Ps",
        "i160-013": "Ps",
        "i160-014": "Ps",
        "i160-015": "Ps",
        "i160-021": "Ps",
        "i160-022": "Ps",
        "i160-023": "Ps",
        "i160-024": "Ps",
        "i160-025": "Ps",
        "i160-031": "Ps",
        "i160-032": "Ps",
        "i160-033": "NPs",
        "i160-034": "Ps",
        "i160-035": "Ps",
        "i160-041": "Ps",
        "i160-042": "Ps",
        "i160-043": "NPs",
        "i160-044": "Ps",
        "i160-045": "NPs",
        "i160-101": "Ps",
        "i160-102": "Ps",
        "i160-103": "Ps",
        "i160-104": "Ps",
        "i160-105": "Ps",
        "i160-111": "Ps",
        "i160-112": "NPs",
        "i160-113": "Ps",
        "i160-114": "Ps",
        "i160-115": "NPm",
        "i160-121": "Pm",
        "i160-122": "Ps",
        "i160-123": "Ps",
        "i160-124": "Ps",
        "i160-125": "Ps",
        "i160-131": "Ps",
        "i160-132": "Ps",
        "i160-133": "Ps",
        "i160-134": "Ps",
        "i160-135": "Ps",
        "i160-141": "Ps",
        "i160-142": "NPm",
        "i160-143": "Ps",
        "i160-144": "NPm",
        "i160-145": "Ps",
        "i160-201": "NPs",
        "i160-202": "Ps",
        "i160-203": "Ps",
        "i160-204": "Ps",
        "i160-205": "Ps",
        "i160-211": "NPm",
        "i160-212": "NPm",
        "i160-213": "NPm",
        "i160-214": "NPm",
        "i160-215": "NPm",
        "i160-221": "Pm",
        "i160-222": "Pm",
        "i160-223": "Pm",
        "i160-224": "Pm",
        "i160-225": "Pm",
        "i160-231": "Ps",
        "i160-232": "NPs",
        "i160-233": "Ps",
        "i160-234": "Ps",
        "i160-235": "Ps",
        "i160-241": "NPh",
        "i160-242": "NPh",
        "i160-243": "NPm",
        "i160-244": "NPm",
        "i160-245": "NPm",
        "i160-301": "Ps",
        "i160-302": "Ps",
        "i160-303": "Ps",
        "i160-304": "Ps",
        "i160-305": "NPs",
        "i160-311": "NPm",
        "i160-312": "NPm",
        "i160-313": "NPh",
        "i160-314": "NPm",
        "i160-315": "NPm",
        "i160-321": "Pm",
        "i160-322": "NPm",
        "i160-323": "Pm",
        "i160-324": "NPm",
        "i160-325": "NPm",
        "i160-331": "Ps",
        "i160-332": "NPs",
        "i160-333": "Ps",
        "i160-334": "Ps",
        "i160-335": "Ps",
        "i160-341": "NPh",
        "i160-342": "NPd",
        "i160-343": "NPh",
        "i160-344": "NPh",
        "i160-345": "NPh",
    },
    "i320": {
        "i320-001": "Ps",
        "i320-002": "Ps",
        "i320-003": "Ps",
        "i320-004": "Ps",
        "i320-005": "Ps",
        "i320-011": "NPs",
        "i320-012": "Ps",
        "i320-013": "Ps",
        "i320-014": "NPs",
        "i320-015": "NPs",
        "i320-021": "Lm",
        "i320-022": "Pm",
        "i320-023": "Pm",
        "i320-024": "Pm",
        "i320-025": "Pm",
        "i320-031": "NPs",
        "i320-032": "NPs",
        "i320-033": "Ps",
        "i320-034": "Ps",
        "i320-035": "Ps",
        "i320-041": "Ps",
        "i320-042": "Ps",
        "i320-043": "NPm",
        "i320-044": "Ps",
        "i320-045": "Ps",
        "i320-101": "Ps",
        "i320-102": "Ps",
        "i320-103": "Ps",
        "i320-104": "Ps",
        "i320-105": "Ps",
        "i320-111": "NPm",
        "i320-112": "NPm",
        "i320-113": "NPm",
        "i320-114": "NPm",
        "i320-115": "NPs",
        "i320-121": "Pm",
        "i320-122": "Pm",
        "i320-123": "Pm",
        "i320-124": "Pm",
        "i320-125": "Pm",
        "i320-131": "Ps",
        "i320-132": "Ps",
        "i320-133": "Ps",
        "i320-134": "Ps",
        "i320-135": "NPs",
        "i320-141": "NPh",
        "i320-142": "Pm",
        "i320-143": "Pm",
        "i320-144": "Ps",
        "i320-145": "NPm",
        "i320-201": "Ps",
        "i320-202": "Ps",
        "i320-203": "Ps",
        "i320-204": "Ps",
        "i320-205": "NPs",
        "i320-211": "NPm",
        "i320-212": "NPm",
        "i320-213": "NPm",
        "i320-214": "NPm",
        "i320-215": "NPh",
        "i320-221": "NPh",
        "i320-222": "NPh",
        "i320-223": "NPm",
        "i320-224": "NPm",
        "i320-225": "NPm",
        "i320-231": "NPs",
        "i320-232": "NPs",
        "i320-233": "Ps",
        "i320-234": "Ps",
        "i320-235": "Ps",
        "i320-241": "NPh",
        "i320-242": "NPh",
        "i320-243": "NPh",
        "i320-244": "NPh",
        "i320-245": "NPh",
        "i320-301": "Ps",
        "i320-302": "Ps",
        "i320-303": "Ps",
        "i320-304": "Ps",
        "i320-305": "NPs",
        "i320-311": "NPd",
        "i320-312": "NPd",
        "i320-313": "NPd",
        "i320-314": "NPd",
        "i320-315": "NPd",
        "i320-321": "NPh",
        "i320-322": "NPh",
        "i320-323": "NPh",
        "i320-324": "NPh",
        "i320-325": "NPh",
        "i320-331": "NPs",
        "i320-332": "NPs",
        "i320-333": "NPs",
        "i320-334": "Ps",
        "i320-335": "NPs",
        "i320-341": "NPh",
        "i320-342": "NPh",
        "i320-343": "NPh",
        "i320-344": "NPh",
        "i320-345": "NPh",
    },
    "i640": {
        "i640-001": "Ps",
        "i640-002": "Ps",
        "i640-003": "Ps",
        "i640-004": "Ps",
        "i640-005": "Ps",
        "i640-011": "Ps",
        "i640-012": "Ps",
        "i640-013": "Ps",
        "i640-014": "Ps",
        "i640-015": "NPs",
        "i640-021": "Pm",
        "i640-022": "?m",
        "i640-023": "Pm",
        "i640-024": "?m",
        "i640-025": "Pm",
        "i640-031": "Ps",
        "i640-032": "Ps",
        "i640-033": "Ps",
        "i640-034": "Ps",
        "i640-035": "Ps",
        "i640-041": "Pm",
        "i640-042": "NPm",
        "i640-043": "NPm",
        "i640-044": "NPm",
        "i640-045": "Pm",
        "i640-101": "Ps",
        "i640-102": "Ps",
        "i640-103": "Ps",
        "i640-104": "Ps",
        "i640-105": "NPs",
        "i640-111": "NPm",
        "i640-112": "NPm",
        "i640-113": "NP?",
        "i640-114": "NPm",
        "i640-115": "NPh",
        "i640-121": "?m",
        "i640-122": "??",
        "i640-123": "??",
        "i640-124": "??",
        "i640-125": "??",
        "i640-131": "Ps",
        "i640-132": "NPs",
        "i640-133": "Ps",
        "i640-134": "Ps",
        "i640-135": "NPs",
        "i640-141": "NPm",
        "i640-142": "NPm",
        "i640-143": "NPm",
        "i640-144": "NPm",
        "i640-145": "NPm",
        "i640-201": "NPs",
        "i640-202": "Ps",
        "i640-203": "Ps",
        "i640-204": "Ps",
        "i640-205": "NPs",
        "i640-211": "NP?",
        "i640-212": "NP?",
        "i640-213": "NP?",
        "i640-214": "NP?",
        "i640-215": "NP?",
        "i640-221": "??",
        "i640-222": "??",
        "i640-223": "??",
        "i640-224": "??",
        "i640-225": "??",
        "i640-231": "NPm",
        "i640-232": "NPs",
        "i640-233": "NPm",
        "i640-234": "Ps",
        "i640-235": "NPm",
        "i640-241": "NPh",
        "i640-242": "NPh",
        "i640-243": "NPh",
        "i640-244": "NPh",
        "i640-245": "NPh",
        "i640-301": "Ps",
        "i640-302": "Ps",
        "i640-303": "Ps",
        "i640-304": "Ps",
        "i640-305": "Ps",
        "i640-311": "NP?",
        "i640-312": "NP?",
        "i640-313": "NP?",
        "i640-314": "NP?",
        "i640-315": "NP?",
        "i640-321": "??",
        "i640-322": "??",
        "i640-323": "??",
        "i640-324": "??",
        "i640-325": "??",
        "i640-331": "NPm",
        "i640-332": "NPm",
        "i640-333": "NPm",
        "i640-334": "NP?",
        "i640-335": "NPm",
        "i640-341": "NP?",
        "i640-342": "NP?",
        "i640-343": "NP?",
        "i640-344": "NP?",
        "i640-345": "NP?",
    }
}

import pandas as pd
from scipy.stats import wilcoxon
import xlwt
import xlrd


def comparison():
    grasp_path = "grasp_sfp_important.txt"
    dm_grasp_path = "dm_grasp_sfp_important.txt"

    grasp_metrics = get_metrics(grasp_path, True)

    dm_grasp_metrics = get_metrics(dm_grasp_path, True)

    dm_together = grasp_metrics.merge(dm_grasp_metrics, on="Instância")

    def get_relation(x, y):
        if x == y:
            return "IGUAL"
        if x < y:
            return "GRASP"
        return "DM_GRASP"

    dm_together["Tempo Melhor"] = dm_together.apply(lambda x: get_relation(x["Tempo_x"], x["Tempo_y"]),
                                                    axis=1)

    dm_together["Best Melhor"] = dm_together.apply(lambda x: get_relation(x["Melhor_x"], x["Melhor_y"]),
                                                   axis=1)

    dm_together["Média Melhor"] = dm_together.apply(lambda x: get_relation(x["Média_x"], x["Média_y"]),
                                                    axis=1)

    dm_together["Relevância"] = dm_together.apply(
        lambda x: "SIM" if wilcoxon(x=x["Valores_x"], y=x["Valores_y"], mode="exact", zero_method="zsplit")[
                               1] < 0.05 else "NAO", axis=1)

    dm_together.to_excel("comparação.xls")


def get_metrics(path="constructor_important.txt", return_df=False, use_pattern_size=False, use_iter_found=False):
    with open(path) as fp:
        lines = fp.readlines()
    instances_dict = {}
    for line in lines:
        splited_line = line.split(" ")
        try:
            instance_name = splited_line[0].split("/")[-1].split(".")[0]
            if use_iter_found:
                iter = float(splited_line[1])
                time = float(splited_line[2])
                found_cost = float(splited_line[3])
                target = float(splited_line[4])
            else:

                value = float(splited_line[1])
                time = float(splited_line[2])
                if use_pattern_size:
                    max_pattern = float(splited_line[3])
                    min_pattern = float(splited_line[4])
            if instance_name not in instances_dict:
                if use_pattern_size:
                    instances_dict[instance_name] = {
                        "values": [value],
                        "times": [time],
                        "max_pattern": [max_pattern],
                        "min_pattern": [min_pattern]
                    }
                elif use_iter_found:
                    instances_dict[instance_name] = {
                        "iter": [iter],
                        "times": [time],
                        "found_cost": [found_cost],
                        "target": [target]
                    }
                else:
                    instances_dict[instance_name] = {
                        "values": [value],
                        "times": [time]
                    }
            else:
                if use_pattern_size:
                    instances_dict[instance_name]["values"].append(value)
                    instances_dict[instance_name]["times"].append(time)
                    instances_dict[instance_name]["max_pattern"].append(max_pattern)
                    instances_dict[instance_name]["min_pattern"].append(min_pattern)
                elif use_iter_found:
                    instances_dict[instance_name]["iter"].append(iter)
                    instances_dict[instance_name]["times"].append(time)
                    instances_dict[instance_name]["found_cost"].append(found_cost)
                    instances_dict[instance_name]["target"].append(target)
                else:
                    instances_dict[instance_name]["values"].append(value)
                    instances_dict[instance_name]["times"].append(time)
        except:
            continue

    if use_pattern_size:
        df_dict = {
            "Instância": [],
            # "Dificuldade": [],
            "Melhor": [],
            "Média": [],
            "Tempo": [],
            "Maior Padrão": [],
            "Menor Padrão": []
        }
    elif use_iter_found:
        df_dict = {
            "Instância": [],
            "Iterações": [],
            "Alvo": [],
            "Encontrado": [],
            "Tempo": [],
        }
    else:
        df_dict = {
            "Instância": [],
            # "Dificuldade": [],
            "Melhor": [],
            "Média": [],
            "Tempo": [],
        }

    values_dict_list = []

    for instance, data in instances_dict.items():
        if not use_iter_found:
            if len(data["values"]) != 10:
                print(f"Erro na instancia: {instance}")
                continue
            best = min(data["values"])
            avg = sum(data["values"]) / 10.0
            time = sum(data["times"]) / 10.0


        instance_type = instance.split("-")[0]

        instance_number = instance.split("_")[0]

        try:
            if use_iter_found:
                import numpy as np
                df_dict["Instância"].append(instance)
                df_dict["Iterações"].append(np.mean(data["iter"]))
                df_dict["Alvo"].append(np.mean(data["target"]))
                df_dict["Encontrado"].append(np.mean(data["found_cost"]))
                df_dict["Tempo"].append(np.mean(data["times"]))
            else:
                # difficulty = families_dict[instance_type][instance_number]
                df_dict["Instância"].append(instance)
                # df_dict["Dificuldade"].append(difficulty)
                df_dict["Melhor"].append(best)
                df_dict["Média"].append(avg)
                df_dict["Tempo"].append(time)
                values_dict_list.append(data["values"])
                if use_pattern_size:
                    max_pattern = sum(data["max_pattern"]) / 10
                    min_pattern = sum(data["min_pattern"]) / 10
                    df_dict["Maior Padrão"].append(max_pattern)
                    df_dict["Menor Padrão"].append(min_pattern)

        except:
            continue

    if return_df:
        df_dict["Valores"] = values_dict_list
        df = pd.DataFrame(data=df_dict)
        return df
    else:
        df = pd.DataFrame(data=df_dict)
        df.to_excel("../../Instances/time_plots/grasp_iters_to_best.xls")


def ghalami():
    with open("ghalami_all.txt") as fp:
        lines = fp.readlines()
    df_dict = {
        "Instância": [],
        "Melhor": [],
        "Tempo": []
    }

    df_to_use = pd.read_excel("../../Instances/time_plots/dm_grasp_with_grasp_time_corrigido.xls")

    instances_to_use = [x.strip().split("_")[0] for x in df_to_use["Instância"].unique()]

    for line in lines:
        splited_line = line.split(" ")

        instance_name = splited_line[0].split("/")[-1].split(".")[0]

        instance_type = instance_name.split("-")[0]

        if instance_name in instances_to_use:
            value = float(splited_line[2])
            time = float(splited_line[3])

            df_dict["Instância"].append(instance_name)
            df_dict["Melhor"].append(value)
            df_dict["Tempo"].append(time)

    df = pd.DataFrame(data=df_dict)

    df.to_excel("ghalami_all.xls")


get_metrics("../../Instances/time_plots/grasp_iters_to_best.txt", False, False, True)
# comparison()
